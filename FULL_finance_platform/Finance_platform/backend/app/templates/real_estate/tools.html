<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real Estate Model Playground</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", system-ui, sans-serif;
      }
      body {
        margin: 0;
        padding: 1.5rem;
        background: #0f172a;
        color: #f8fafc;
      }
      h1 {
        margin-bottom: 1rem;
        font-size: 2rem;
        font-weight: 700;
      }
      .intro {
        max-width: 760px;
        margin-bottom: 1.5rem;
        color: #cbd5f5;
      }
      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
      }
      .tab-button {
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        background: #1e293b;
        color: #cbd5f5;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
      }
      .tab-button.active {
        background: linear-gradient(120deg, #38bdf8, #818cf8);
        color: #0f172a;
        font-weight: 600;
      }
      .tab-button:hover {
        transform: translateY(-2px);
      }
      .panels {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
      }
      .card {
        background: #111c34;
        border-radius: 18px;
        padding: 1.25rem;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.45);
        border: 1px solid rgba(148, 163, 184, 0.12);
      }
      .card h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: 1.3rem;
        font-weight: 600;
      }
      form {
        display: grid;
        gap: 0.75rem;
      }
      label {
        display: block;
        font-size: 0.9rem;
        color: #e2e8f0;
        margin-bottom: 0.3rem;
      }
      input,
      select {
        width: 100%;
        padding: 0.55rem 0.65rem;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(15, 23, 42, 0.6);
        color: #f8fafc;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: #38bdf8;
        box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.25);
      }
      button.submit {
        margin-top: 0.8rem;
        padding: 0.7rem 1.2rem;
        border-radius: 12px;
        border: none;
        background: linear-gradient(120deg, #38bdf8, #818cf8);
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
      }
      button.submit:hover {
        filter: brightness(1.05);
      }
      .results {
        grid-column: 1 / -1;
        background: rgba(15, 23, 42, 0.4);
      }
      .tables {
        display: grid;
        gap: 1.25rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(15, 23, 42, 0.6);
        border-radius: 12px;
        overflow: hidden;
      }
      table thead {
        background: rgba(129, 140, 248, 0.15);
      }
      table th,
      table td {
        padding: 0.6rem 0.75rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        text-align: left;
        font-size: 0.85rem;
      }
      table tbody tr:last-child td {
        border-bottom: none;
      }
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }
      .metric-card {
        background: rgba(56, 189, 248, 0.08);
        border: 1px solid rgba(56, 189, 248, 0.12);
        padding: 0.85rem;
        border-radius: 12px;
      }
      .metric-card h3 {
        margin: 0 0 0.4rem;
        font-size: 0.9rem;
        color: #bae6fd;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .metric-card p {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 600;
      }
      canvas {
        background: rgba(15, 23, 42, 0.6);
        border-radius: 12px;
        padding: 0.75rem;
      }
      .hidden {
        display: none !important;
      }
      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }
        .panels {
          grid-template-columns: 1fr;
        }
        canvas {
          max-height: 320px;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <h1>Real Estate Model Playground</h1>
    <p class="intro">
      Explore institutional-grade financial models pulled directly from the Excel workbooks.
      Select a template, adjust a few core assumptions, and instantly review the key tables and
      visualizations that mirror the reporting experience inside the spreadsheets.
    </p>

    <div class="tabs" id="model-tabs">
      {% for slug, config in model_configs.items() %}
      <button class="tab-button{% if loop.first %} active{% endif %}" data-model="{{ slug }}">
        {{ config.label }}
      </button>
      {% endfor %}
    </div>

    <div class="panels">
      {% for slug, config in model_configs.items() %}
      <div class="card{% if slug != active_model %} hidden{% endif %}" id="form-{{ slug }}">
        <h2>{{ config.label }} Inputs</h2>
        <form class="model-form" data-model="{{ slug }}">
          {% for field in config.fields %}
          <div>
            <label for="{{ slug }}-{{ field.name }}">{{ field.label }}</label>
            {% if field.options %}
            <select id="{{ slug }}-{{ field.name }}" name="{{ field.name }}">
              {% for option in field.options %}
              <option value="{{ option }}" {% if config.defaults[field.name] == option %}selected{% endif %}>
                {{ option }}
              </option>
              {% endfor %}
            </select>
            {% else %}
            <input
              id="{{ slug }}-{{ field.name }}"
              type="{{ field.type }}"
              name="{{ field.name }}"
              step="{{ field.step|default('any') }}"
              {% if field.min is not none %}min="{{ field.min }}"{% endif %}
              {% if field.max is not none %}max="{{ field.max }}"{% endif %}
              value="{{ config.defaults[field.name] }}"
            />
            {% endif %}
          </div>
          {% endfor %}
          <button type="submit" class="submit">Run analysis</button>
        </form>
      </div>
      {% endfor %}

      <div class="card results" id="results-panel">
        <h2 id="results-title">Results</h2>
        <div id="results-container"></div>
      </div>
    </div>

    <script>
      const modelConfigs = {{ model_configs|tojson }};
      const formDefaults = Object.fromEntries(
        Object.entries(modelConfigs).map(([slug, cfg]) => [slug, cfg.defaults])
      );
      const resultsContainer = document.getElementById("results-container");
      const resultsTitle = document.getElementById("results-title");

      const chartsByModel = {};

      function buildMetricCard(title, metrics) {
        const wrapper = document.createElement("div");
        wrapper.className = "metrics-grid";
        Object.entries(metrics).forEach(([label, value]) => {
          const card = document.createElement("div");
          card.className = "metric-card";
          const heading = document.createElement("h3");
          heading.textContent = label;
          const paragraph = document.createElement("p");
          paragraph.textContent = value;
          card.appendChild(heading);
          card.appendChild(paragraph);
          wrapper.appendChild(card);
        });
        const container = document.createElement("div");
        const header = document.createElement("h3");
        header.textContent = title;
        container.appendChild(header);
        container.appendChild(wrapper);
        return container;
      }

      function buildTable(table) {
        const container = document.createElement("div");
        const header = document.createElement("h3");
        header.textContent = table.title;
        container.appendChild(header);

        const tbl = document.createElement("table");
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        table.columns.forEach((col) => {
          const th = document.createElement("th");
          th.textContent = col;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        tbl.appendChild(thead);

        const tbody = document.createElement("tbody");
        table.rows.forEach((row) => {
          const tr = document.createElement("tr");
          table.columns.forEach((col) => {
            const td = document.createElement("td");
            td.textContent = row[col] ?? row[col.toLowerCase()] ?? "";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        container.appendChild(tbl);
        return container;
      }

      function renderCharts(slug, charts) {
        if (!chartsByModel[slug]) {
          chartsByModel[slug] = {};
        }
        Object.values(chartsByModel[slug]).forEach((instance) => instance.destroy());
        chartsByModel[slug] = {};

        const wrapper = document.createElement("div");
        wrapper.className = "tables";

        charts.forEach((chart) => {
          const block = document.createElement("div");
          const header = document.createElement("h3");
          header.textContent = chart.title;
          block.appendChild(header);
          const canvas = document.createElement("canvas");
          block.appendChild(canvas);
          wrapper.appendChild(block);

          const chartConfig = {
            type: chart.type === "bar" ? "bar" : "line",
            data: {
              labels: chart.labels,
              datasets:
                chart.type === "bar"
                  ? chart.datasets.map((ds) => ({
                      label: ds.label,
                      data: ds.data,
                      backgroundColor: [
                        "#38bdf8",
                        "#818cf8",
                        "#fbbf24",
                        "#22d3ee",
                        "#f472b6",
                      ],
                    }))
                  : Object.entries(chart.datasets).map(([label, data]) => ({
                      label,
                      data,
                      borderWidth: 2,
                      tension: 0.25,
                    })),
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  title: { display: Boolean(chart.x_label), text: chart.x_label },
                  ticks: { color: "#cbd5f5" },
                  grid: { color: "rgba(148, 163, 184, 0.12)" },
                },
                y: {
                  title: { display: Boolean(chart.y_label), text: chart.y_label },
                  ticks: { color: "#cbd5f5" },
                  grid: { color: "rgba(148, 163, 184, 0.12)" },
                },
              },
              plugins: {
                legend: { labels: { color: "#e2e8f0" } },
              },
            },
          };
          chartsByModel[slug][chart.key] = new Chart(canvas, chartConfig);
        });

        return wrapper;
      }

      function renderResults(slug, payload) {
        resultsContainer.innerHTML = "";
        resultsTitle.textContent = `${modelConfigs[slug].label} Results`;

        const tablesWrapper = document.createElement("div");
        tablesWrapper.className = "tables";

        payload.tables.forEach((table) => {
          if (table.kind === "metrics") {
            tablesWrapper.appendChild(buildMetricCard(table.title, table.metrics));
          } else {
            tablesWrapper.appendChild(buildTable(table));
          }
        });
        resultsContainer.appendChild(tablesWrapper);

        if (payload.charts && payload.charts.length) {
          resultsContainer.appendChild(renderCharts(slug, payload.charts));
        }
      }

      function handleSubmit(event) {
        event.preventDefault();
        const form = event.currentTarget;
        const slug = form.dataset.model;
        const formData = new FormData(form);
        const overrides = {};
        formData.forEach((value, key) => {
          overrides[key] = value;
        });

        fetch("/api/v1/real-estate/tools/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model: slug, values: overrides }),
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("Request failed");
            }
            return res.json();
          })
          .then((data) => {
            renderResults(slug, data);
          })
          .catch((err) => {
            resultsContainer.innerHTML = `<p style="color:#f87171">${err.message}</p>`;
          });
      }

      document.querySelectorAll(".model-form").forEach((form) => {
        form.addEventListener("submit", handleSubmit);
      });

      const tabs = document.getElementById("model-tabs");
      tabs.addEventListener("click", (event) => {
        const button = event.target.closest(".tab-button");
        if (!button) return;
        const slug = button.dataset.model;

        document.querySelectorAll(".tab-button").forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");

        document.querySelectorAll(".card").forEach((panel) => {
          if (panel.id === `form-${slug}` || panel.id === "results-panel") {
            panel.classList.remove("hidden");
          } else if (panel.id.startsWith("form-")) {
            panel.classList.add("hidden");
          }
        });

        resultsContainer.innerHTML = "";
        resultsTitle.textContent = `${modelConfigs[slug].label} Results`;
      });

      // Boot with default model rendered
      const initialSlug = "{{ active_model }}";
      resultsTitle.textContent = `${modelConfigs[initialSlug].label} Results`;
    </script>
  </body>
</html>
